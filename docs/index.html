<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ Periphery (Web App)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color, #f4f4f4);
            color: var(--tg-theme-text-color, #333333);
        }

        .product-card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
            border-radius: 0.5rem;
        }

        .product-card:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            transition: background-color 0.15s;
        }

        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--tg-theme-button-color, #007bff) 80%, black);
        }

        .status-bar,
        .filter-bar {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
        }

        .filter-active {
            background-color: var(--tg-theme-link-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .filter-inactive {
            background-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #333333);
        }

        .loading-dot {
            animation: bounce 0.6s infinite alternate;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            to {
                transform: translateY(-5px);
            }
        }
    </style>
</head>

<body class="min-h-screen p-4">

    <div class="status-bar sticky top-0 z-10 p-3 mb-4 rounded-lg">
        <h1 class="text-2xl font-bold">üéÆ –ö–∞—Ç–∞–ª–æ–≥ Periphery</h1>
        <p class="text-sm opacity-80 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏ –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –∏—Ö –≤ –∫–æ—Ä–∑–∏–Ω—É –±–æ—Ç–∞.</p>
        <p id="apiStatus" class="text-xs text-green-600 mt-1">–°—Ç–∞—Ç—É—Å API: –û–∂–∏–¥–∞–Ω–∏–µ...</p>
        <p id="cartCount" class="text-sm mt-2 font-semibold">–í –∫–æ—Ä–∑–∏–Ω–µ Web App: 0 —Ç–æ–≤–∞—Ä–æ–≤ (0 ‚Ç¥)</p>
    </div>

    <div class="filter-bar sticky top-28 z-20 p-3 mb-4 rounded-lg border-b border-gray-200 shadow-md">
        <input type="text" id="searchInput" placeholder="–ò—Å–∫–∞—Ç—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –æ–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..."
            class="w-full p-2 mb-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 text-black"
            oninput="debouncedSearch()">

        <p class="text-sm font-semibold mb-2 opacity-80">üîé –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</p>

        <div id="filterTags" class="flex flex-wrap gap-2"></div>
    </div>

    <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 pb-20 pt-4">
        <div id="loadingIndicator" class="col-span-full text-center p-8 text-lg font-medium opacity-70">
            –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
            <span class="flex justify-center mt-2">
                <span class="loading-dot w-2 h-2 rounded-full bg-blue-500 mx-1"></span>
                <span class="loading-dot w-2 h-2 rounded-full bg-blue-500 mx-1"></span>
                <span class="loading-dot w-2 h-2 rounded-full bg-blue-500 mx-1"></span>
            </span>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-full p-4 status-bar border-t border-gray-200 shadow-xl flex gap-2">
        <button id="viewCartButton" class="w-1/3 py-3 rounded-lg text-lg font-bold disabled:opacity-50"
            style="background-color: var(--tg-theme-hint-color); color: var(--tg-theme-button-text-color);" disabled>
            <span id="viewCartCount">0</span> üõçÔ∏è
        </button>

        <button id="transferCartButton" class="btn-primary w-2/3 py-3 rounded-lg text-lg font-bold disabled:opacity-50"
            disabled>
            –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É –ë–æ—Ç–∞
        </button>
    </div>

    <div id="cartModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="product-card w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 flex flex-col"
            style="background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);">

            <h2 class="text-2xl font-bold mb-4 border-b pb-2">–í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞ üõçÔ∏è</h2>

            <div id="cartItemsContainer" class="flex-grow space-y-4 mb-6">
                <p id="cartEmptyMessage" class="text-center opacity-70">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
            </div>

            <div id="cartSummary" class="mt-auto pt-4 border-t">
                <p class="text-xl font-bold">–ò—Ç–æ–≥–æ: <span id="cartTotalPrice">0 ‚Ç¥</span></p>
                <button id="modalTransferCartButton" class="btn-primary w-full py-3 mt-4 rounded-lg text-lg font-bold">
                    –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É –ë–æ—Ç–∞
                </button>
                <button id="closeCartModalButton" class="w-full py-2 mt-2 rounded-lg text-sm"
                    style="background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color);">
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                </button>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let webAppCart = {};
        let activeFilter = '–í—Å–µ';
        let searchTimeout = null;
        let mainButtonBound = false;
        

        const API_BASE_URL = 'https://telegrambotwebapp1-production.up.railway.app/webapp/index.html'; 

        const tgWebApp = window.Telegram.WebApp;

        function initWebApp() {
            if (tgWebApp) {
                tgWebApp.ready();

                document.body.style.backgroundColor = tgWebApp.themeParams.bg_color;
                document.querySelectorAll('.status-bar, .filter-bar').forEach(el =>
                    el.style.backgroundColor = tgWebApp.themeParams.secondary_bg_color
                );
                document.getElementById('transferCartButton').style.backgroundColor = tgWebApp.themeParams.button_color;
                document.getElementById('transferCartButton').style.color = tgWebApp.themeParams.button_text_color;

                if (tgWebApp.setHeaderColor) {
                    tgWebApp.setHeaderColor('secondary_bg_color');
                }
                if (tgWebApp.BackButton) {
                    tgWebApp.BackButton.hide();
                }

                console.log("DEBUG: Telegram Web App SDK is ready.");
            } else {
                console.warn("DEBUG: Telegram Web App SDK not found. Running in standalone mode.");
            }
        }

        function updateCartUI() {
            const cartItemsArray = Object.values(webAppCart);
            const totalItems = cartItemsArray.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cartItemsArray.reduce((sum, item) =>
                sum + (typeof item.product.price === 'number' ? item.product.price * item.quantity : 0), 0
            );

            const isCartEmpty = totalItems === 0;

            document.getElementById('cartCount').textContent = `–í –∫–æ—Ä–∑–∏–Ω–µ Web App: ${totalItems} —Ç–æ–≤–∞—Ä–æ–≤ (${totalPrice.toLocaleString('ru-RU')} ‚Ç¥)`;
            document.getElementById('viewCartCount').textContent = totalItems;

            const transferButton = document.getElementById('transferCartButton');
            transferButton.disabled = isCartEmpty;
            document.getElementById('viewCartButton').disabled = isCartEmpty;

            if (tgWebApp && tgWebApp.MainButton) {
                if (!isCartEmpty) {
                    tgWebApp.MainButton.setText(`–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ (${totalItems}) —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–æ—Ç–∞`);
                    if (!mainButtonBound) {
                        tgWebApp.MainButton.onClick(handleTransferCart);
                        mainButtonBound = true;
                        console.log("DEBUG: MainButton listener attached.");
                    }
                    tgWebApp.MainButton.show();
                } else {
                    tgWebApp.MainButton.hide();
                }
            }

            if (document.getElementById('cartModal') && !document.getElementById('cartModal').classList.contains('hidden')) {
                renderCartModal();
            }
        }

        function addItemToCart(product) {
            const productId = product.id;

            if (webAppCart[productId]) {
                webAppCart[productId].quantity += 1;
            } else {
                webAppCart[productId] = {
                    product: product,
                    quantity: 1
                };
            }

            updateCartUI();

            if (tgWebApp && tgWebApp.HapticFeedback) {
                tgWebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        function handleQuantityChange(event) {
            const productId = parseInt(event.target.getAttribute('data-id'), 10);
            const action = event.target.getAttribute('data-action');

            if (webAppCart[productId]) {
                if (action === 'increment') {
                    webAppCart[productId].quantity += 1;
                } else if (action === 'decrement') {
                    webAppCart[productId].quantity -= 1;
                    if (webAppCart[productId].quantity <= 0) {
                        delete webAppCart[productId];
                    }
                }
            }

            updateCartUI();
        }

        function renderCartModal() {
            const container = document.getElementById('cartItemsContainer');
            const cartItemsArray = Object.values(webAppCart);
            const isCartEmpty = cartItemsArray.length === 0;
            const totalPrice = cartItemsArray.reduce((sum, item) =>
                sum + (typeof item.product.price === 'number' ? item.product.price * item.quantity : 0), 0
            );

            container.innerHTML = '';
            document.getElementById('cartEmptyMessage').style.display = isCartEmpty ? 'block' : 'none';
            document.getElementById('cartTotalPrice').textContent = `${totalPrice.toLocaleString('ru-RU')} ‚Ç¥`;
            document.getElementById('modalTransferCartButton').disabled = isCartEmpty;

            if (isCartEmpty) return;

            cartItemsArray.forEach(item => {
                const product = item.product;
                const itemId = product.id;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between p-3 border rounded-lg product-card';

                itemDiv.innerHTML = `
                    <div class="flex-grow min-w-0 mr-4">
                        <p class="font-semibold truncate">${product.name}</p>
                        <p class="text-sm opacity-70">${(product.price * item.quantity).toLocaleString('ru-RU')} ‚Ç¥ (–ø–æ ${product.price.toLocaleString('ru-RU')} ‚Ç¥)</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-id="${itemId}" data-action="decrement" class="quantity-btn px-2 py-1 rounded-full text-sm font-bold"
                                style="background-color: var(--tg-theme-link-color); color: var(--tg-theme-button-text-color);">-</button>
                        <span class="font-bold w-6 text-center">${item.quantity}</span>
                        <button data-id="${itemId}" data-action="increment" class="quantity-btn px-2 py-1 rounded-full text-sm font-bold"
                                style="background-color: var(--tg-theme-link-color); color: var(--tg-theme-button-text-color);">+</button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', handleQuantityChange);
            });
        }

        function openCartModal() {
            if (Object.keys(webAppCart).length === 0) {
                if (tgWebApp) tgWebApp.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã.');
                return;
            }
            renderCartModal();
            document.getElementById('cartModal').classList.remove('hidden');
            if (tgWebApp && tgWebApp.BackButton) {
                tgWebApp.BackButton.show();
                tgWebApp.BackButton.onClick(closeCartModal);
            }
        }

        function closeCartModal() {
            document.getElementById('cartModal').classList.add('hidden');
            if (tgWebApp && tgWebApp.BackButton) {
                tgWebApp.BackButton.hide();
                tgWebApp.BackButton.offClick(closeCartModal);
            }
        }

        function getUniqueCategories(productsList) {
            const categories = new Set(productsList.map(p => p.type || p.category));
            return ['–í—Å–µ', ...Array.from(categories)];
        }

        function renderFilterTags(categories) {
            const container = document.getElementById('filterTags');
            container.innerHTML = '';

            categories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = `px-3 py-1 text-sm font-medium rounded-full transition duration-150 ease-in-out whitespace-nowrap`;
                button.classList.add(category === activeFilter ? 'filter-active' : 'filter-inactive');
                button.onclick = () => setActiveFilter(category);
                container.appendChild(button);
            });
        }

        function setActiveFilter(category) {
            activeFilter = category;
            renderFilterTags(getUniqueCategories(products));
            applyFilters();
        }

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const filteredByCategory = products.filter(product => {
                const productType = product.type || product.category;
                return activeFilter === '–í—Å–µ' || (productType && productType === activeFilter);
            });

            const finalFilteredList = filteredByCategory.filter(product => {
                const productType = product.type || product.category || '';
                const productDesc = product.description || '';

                return product.name.toLowerCase().includes(searchTerm) ||
                    productType.toLowerCase().includes(searchTerm) ||
                    productDesc.toLowerCase().includes(searchTerm);
            });

            renderProducts(finalFilteredList);
            document.getElementById('productsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function fetchProducts() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);

            try {
                document.getElementById('productsContainer').innerHTML =
                    `<div id="loadingIndicator" class="col-span-full text-center p-8 text-lg font-medium opacity-70">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤... 
                        <span class="flex justify-center mt-2">
                            <span class="loading-dot w-2 h-2 rounded-full bg-blue-500 mx-1"></span>
                            <span class="loading-dot w-2 h-2 rounded-full bg-blue-500 mx-1"></span>
                            <span class="loading-dot w-2 h-2 rounded-full bg-blue-500 mx-1"></span>
                        </span>
                    </div>`;
                
                const apiUrl = `${API_BASE_URL}/products`;

                console.log("DEBUG: Fetching products from:", apiUrl);

                const response = await fetch(apiUrl, { signal: controller.signal });

                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} (${response.statusText})`);
                }
                const data = await response.json();

                if (Array.isArray(data)) {
                    products = data.filter(p => p.id && typeof p.price === 'number');
                } else {
                    console.error("DEBUG: API did not return an array:", data);
                    products = [];
                }

                renderFilterTags(getUniqueCategories(products));
                applyFilters();

                document.getElementById('apiStatus').textContent = '–°—Ç–∞—Ç—É—Å API: –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.';
                console.log("DEBUG: Products successfully loaded.");

            } catch (error) {
                clearTimeout(timeoutId);

                if (error.name === 'AbortError') {
                    document.getElementById('apiStatus').textContent = `–°—Ç–∞—Ç—É—Å API: –¢–∞–π–º–∞—É—Ç.`;
                    console.error("DEBUG: Fetch timeout error.");
                    document.getElementById('productsContainer').innerHTML = `<div class="col-span-full text-center p-8 opacity-70 text-red-500">
                        <p class="text-xl font-medium">‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (–¢–∞–π–º–∞—É—Ç).</p>
                        <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Uvicorn –∑–∞–ø—É—â–µ–Ω –∏ API –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É /products.</p>
                    </div>`;
                    return;
                }

                console.error('DEBUG: Error fetching products:', error);
                document.getElementById('apiStatus').textContent = `–°—Ç–∞—Ç—É—Å API: –û—à–∏–±–∫–∞ (${error.message}).`;
                document.getElementById('productsContainer').innerHTML = `<div class="col-span-full text-center p-8 opacity-70 text-red-500">
                    <p class="text-xl font-medium">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>
                    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É /products.</p>
                </div>`;
            }
        }

        function renderProducts(productsToRender) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';

            if (productsToRender.length === 0 && products.length > 0) {
                container.innerHTML = `<div class="col-span-full text-center p-8 opacity-70">
                    <p class="text-xl font-medium">ü§∑‚Äç‚ôÇÔ∏è –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                    <button onclick="setActiveFilter('–í—Å–µ'); document.getElementById('searchInput').value = '';" 
                            class="mt-4 px-4 py-2 text-sm rounded-full btn-primary">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>`;
                return;
            }

            if (productsToRender.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center p-8 opacity-70 text-yellow-600">
                    <p class="text-xl font-medium">‚ö†Ô∏è –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.</p>
                </div>`;
                return;
            }

            productsToRender.forEach(product => {
                const productType = product.type || product.category || '–ü—Ä–æ—á–µ–µ';
                const productDescription = product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.';

                const emoji = getCategoryEmoji(productType);

                const card = document.createElement('div');
                card.className = 'product-card p-4 flex flex-col justify-between';

                const imagePlaceholderUrl = `https://placehold.co/400x200/4F46E5/FFFFFF?text=${encodeURIComponent(product.name)}`;

                card.innerHTML = `
                    <div>
                        <img src="${imagePlaceholderUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/F0F0F0/333333?text=–ù–µ—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';" class="rounded-t-lg mb-3 object-cover h-32 w-full" alt="${product.name}">
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full mb-2" 
                              style="background-color: var(--tg-theme-hint-color); color: var(--tg-theme-bg-color);">
                            ${emoji} ${productType}
                        </span>
                        <h3 class="text-xl font-semibold">${product.name}</h3>
                        <p class="text-sm mt-2 opacity-80 h-10 overflow-hidden line-clamp-2">${productDescription}</p>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-lg font-bold text-green-500">${product.price.toLocaleString('ru-RU')} ‚Ç¥</span>
                        <button data-id="${product.id}" class="buy-btn btn-primary px-4 py-2 text-sm rounded-full">
                            + –í –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.buy-btn').forEach(button => {
                button.addEventListener('click', handleBuyClick);
            });
        }

        function handleBuyClick(event) {
            const productId = parseInt(event.target.getAttribute('data-id'), 10);
            const product = products.find(p => p.id === productId);

            if (product) {
                addItemToCart(product);
                event.target.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ!';
                event.target.classList.add('opacity-70');

                setTimeout(() => {
                    event.target.textContent = '+ –í –∫–æ—Ä–∑–∏–Ω—É';
                    event.target.classList.remove('opacity-70');
                }, 500);
            }
        }
        
        async function handleTransferCart() {
            console.log("DEBUG: handleTransferCart started.");

            const cartItemsArray = Object.values(webAppCart);
            
            if (cartItemsArray.length === 0) {
                if (tgWebApp) tgWebApp.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.');
                return;
            }

            const initData = tgWebApp.initData || '';
            const userId = tgWebApp.initDataUnsafe?.user?.id || 0;
            
            const simplifiedItems = cartItemsArray.map(item => ({
                id: item.product.id,
                name: item.product.name, 
                price: item.product.price,
                quantity: item.quantity
            }));

            const dataToSend = {
                tg_user_id: userId,
                init_data: initData, 
                items: simplifiedItems
            };

            console.log("DEBUG: Payload constructed with init_data.");
            
            const apiUrl = `${API_BASE_URL}/web-app/send-cart`;
            console.log("DEBUG: Target URL:", apiUrl);
            
            const initialText = tgWebApp.MainButton ? tgWebApp.MainButton.text : '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É –ë–æ—Ç–∞';

            if (tgWebApp.MainButton) {
                tgWebApp.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∫–∞...');
                tgWebApp.MainButton.disable();
            }
            
            closeCartModal();

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                console.log("DEBUG: Fetch attempt finished. Response status:", response.status);

                if (response.ok) {
                    const result = await response.json();
                    
                    webAppCart = {};
                    updateCartUI();
                    
                    if (tgWebApp) {
                        tgWebApp.showAlert(`‚úÖ –ó–∞–∫–∞–∑ ID ${result.order_id || 'N/A'} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.`, 
                            () => tgWebApp.close());
                    } else {
                         console.log('DEBUG: Order successfully sent (Standalone mode).', result);
                    }
                } else {
                    const errorDetails = await response.json().catch(() => ({ detail: response.statusText }));
                    const errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${errorDetails.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}. –°—Ç–∞—Ç—É—Å: ${response.status}`;
                    console.error('DEBUG: Server responded with error:', errorMessage);
                    if (tgWebApp) tgWebApp.showAlert(errorMessage);
                }
            } catch (error) {
                console.error('DEBUG: Network or fetch error caught:', error.message);
                if (tgWebApp) tgWebApp.showAlert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ URL. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.`);
            } finally {
                if (tgWebApp.MainButton) {
                    tgWebApp.MainButton.setText(initialText);
                    tgWebApp.MainButton.enable();
                }
            }
        }

        function getCategoryEmoji(category) {
            switch (category) {
                case '–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è':
                    return 'üñ±Ô∏è';
                case '–ê—É–¥–∏–æ':
                    return 'üéß';
                case '–°—Ç—Ä–∏–º':
                    return 'üìπ';
                case '–î–∏—Å–ø–ª–µ–∏':
                    return 'üñ•Ô∏è';
                case '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã':
                    return 'üîó';
                case '–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã':
                    return 'üéÆ';
                case '–ü—Ä–æ—á–µ–µ':
                    return 'üì¶';
                default:    
                    return ''
            }
        }

        document.getElementById('transferCartButton').addEventListener('click', handleTransferCart);
        document.getElementById('viewCartButton').addEventListener('click', openCartModal);
        document.getElementById('closeCartModalButton').addEventListener('click', closeCartModal);
        document.getElementById('modalTransferCartButton').addEventListener('click', handleTransferCart);

        initWebApp();
        fetchProducts();
    </script>
</body>

</html>